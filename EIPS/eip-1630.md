---
eip: 1630
title: Hashed Time-Locked Contracts
author: TingWei Liu (@i3wgnit), Matthew Black (@mattBlackDesign)
status: Draft
type: Standards Track
category: ERC
created: 2018-11-28
---

## Simple Summary

A standard EVM script for generalized payments that acknowledges receiving the payment prior to a deadline.

## Abstract

A Hashed Time-Lock Contract (HTLC) is a script that permits a designated party (the "seller") to spend funds by disclosing the preimage of a hash. It also permits a second party (the "buyer") to spend the funds after a timeout is reached, in a refund situation.

## Motivation

HTLC transactions are a safe and cheap method of exchanging secrets for money over the blockchain, due to the ability to recover funds from an uncooperative counterparty, and the opportunity that the possessor of a secret has to receive the funds before such a refund can occur.

## Compatibility

[BIP 199](https://github.com/bitcoin/bips/blob/master/bip-0199.mediawiki)

## Implementation

[Liquality Atomic Swaps](https://github.com/liquality/chainabstractionlayer/blob/master/src/providers/ethereum/EthereumSwapProvider.js#L8)


```
// Constructor
PUSH1 {dataSize}
DUP1
PUSH1 0b
PUSH1 00
CODECOPY
PUSH1 00
RETURN

// Contract
PUSH1 20

// Get secret
DUP1
PUSH1 00
DUP1
CALLDATACOPY

// SHA256
PUSH1 21
DUP2
PUSH1 00
DUP1
PUSH1 02
PUSH1 48
CALL

// Validate with secretHash
PUSH32 {secretHashEncoded}
PUSH1 21
MLOAD
EQ
AND (to make sure CALL succeeded)
// Redeem if secret is valid
PUSH1 {redeemDestinationEncoded}
JUMPI

// Check time lock
PUSH{expirationSize}
{expirationEncoded}
TIMESTAMP
GT
// Refund if timelock passed
PUSH1 {refundDestinationEncoded}
'57',

STOP

// Redeem suicide
JUMPDEST
PUSH20 {recipientAddressEncoded}
SUICIDE

// Refund suicide
JUMPDEST
PUSH20 {refundAddressEncoded}
SUICIDE
```

### Implementation Definitions

dataSize: 112 +  expiration size (112 is the size of the contract in bytes after the constructor)

secretHash: hash of secret generated by seller

redeemDestination = 66 + expiration size (66 is the number of bytes between Contract and Redeem suicide)

refundDestination: 89 + expiration size (89 is the number of bytes between Contract and Refund suicide)

expirationSize: bytecode length of expiration 

expiration: expiration time encoded hex

recipientAddress: buyer address
 
refundAddress: seller address


## Rational

Constructor: deploys the contract, using the datasize which is the bytecode size of the rest of the contract

Contract: compute (Keccak-256) hash of contract address

Get secret: copy input data of secret in the current environment to memory

SHA 256: hashes the secret in memory

Validate with SecretHash: checks if secretHash is equal to hash of secret provided

Redeem if secret is valid: jump to the redeem suicide section of the contract

Check timelock: check block's timestamp is greater than expiration

Refund if timelock passed: jump to the refund suicide section of the contract

Redeem suicide: pushes buyer address to the stack, which is passed to SUICIDE which sends funds to the buyer, and destroys the contract

Refund suicide: pushes seller address to the stack, which is passed to SUICIDE which sends funds to the seller, and destroys the contractal


## Copyright
Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).